#!/bin/sh
# Customize hook for bdebstrap: Add kaptive configuration directly into Raspberry Pi's firstboot
# This inlines all kaptive kiosk configuration into the firstboot script

set -eu

ROOTFS="$1"
FIRSTBOOT="$ROOTFS/usr/lib/raspberrypi-sys-mods/firstboot"

# Patch the firstboot script to include our configuration directly
if [ -f "$FIRSTBOOT" ]; then
    if ! grep -q "Configure Kaptive kiosk" "$FIRSTBOOT"; then
        # Insert kaptive configuration before "return 0" in main()
        sed -i '/^  return 0$/i\
  # Configure Kaptive kiosk\
  whiptail --infobox "Configuring Kaptive kiosk..." 20 60\
  mount -o remount,rw /\
  \
  # Detect the primary user (UID 1000) regardless of username\
  KAPTIVE_USER=$(getent passwd 1000 | cut -d: -f1)\
  KAPTIVE_HOME=$(getent passwd 1000 | cut -d: -f6)\
  \
  if [ -n "$KAPTIVE_USER" ] && [ -n "$KAPTIVE_HOME" ]; then\
    echo "Kaptive: Configuring for user $KAPTIVE_USER (home: $KAPTIVE_HOME)" >> /var/log/kaptive_firstboot.log\
    \
    # Update systemd service files with actual username and home directory\
    for svc in /etc/systemd/system/labwc.service \\\
               /etc/systemd/system/squeekboard.service \\\
               /lib/systemd/system/kaptive-launcher.service \\\
               /lib/systemd/system/kaptive-player-agent.service; do\
      if [ -f "$svc" ]; then\
        sed -i -e "s|<KIOSK_USER>|$KAPTIVE_USER|g" \\\
               -e "s|Environment=.XDG_RUNTIME_DIR=[^.]*.|Environment=\"XDG_RUNTIME_DIR=$KAPTIVE_HOME\"|g" "$svc"\
        echo "Kaptive: Updated $svc" >> /var/log/kaptive_firstboot.log\
      fi\
    done\
    \
    # Create labwc config directory and copy templates\
    mkdir -p "$KAPTIVE_HOME/.config/labwc"\
    if [ -d "/etc/skel/.config/labwc" ]; then\
      cp -n /etc/skel/.config/labwc/* "$KAPTIVE_HOME/.config/labwc/" 2>/dev/null || true\
    fi\
    \
    # Set correct ownership\
    chown -R "$KAPTIVE_USER:$KAPTIVE_USER" "$KAPTIVE_HOME/.config"\
    [ -d "/opt/kaptive" ] && chown -R "$KAPTIVE_USER:$KAPTIVE_USER" /opt/kaptive\
    \
    # Re-enable services to ensure symlinks point to updated files\
    systemctl enable labwc.service squeekboard.service kaptive-launcher.service kaptive-player-agent.service 2>/dev/null || true\
    \
    echo "Kaptive: Configuration complete" >> /var/log/kaptive_firstboot.log\
  else\
    echo "Kaptive: ERROR - Could not determine primary user (UID 1000)" >> /var/log/kaptive_firstboot.log\
  fi\
  \
  mount -o remount,ro /
' "$FIRSTBOOT"
        
        # Verify the patch was applied
        if grep -q "Configure Kaptive kiosk" "$FIRSTBOOT"; then
            echo "Patched firstboot to include Kaptive configuration"
        else
            echo "ERROR: Failed to patch firstboot script"
        fi
    fi
else
    echo "Warning: firstboot script not found at $FIRSTBOOT"
fi

echo "Kaptive firstboot configuration installed"
