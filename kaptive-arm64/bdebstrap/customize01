#!/bin/sh

set -eu

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "en_US.UTF-8 UTF-8" > $1/etc/locale.gen

chroot $1 apt install -y locales

# Install kaptive from APT repository

# Prevent services from starting during installation
cat > "$1/usr/sbin/policy-rc.d" << 'EOF'
#!/bin/sh
exit 101
EOF
chmod +x "$1/usr/sbin/policy-rc.d"

# Mask systemctl to prevent systemd calls in postinst scripts
if [ ! -e "$1/usr/bin/systemctl.orig" ] && [ -e "$1/usr/bin/systemctl" ]; then
    mv "$1/usr/bin/systemctl" "$1/usr/bin/systemctl.orig"
fi
cat > "$1/usr/bin/systemctl" << 'EOF'
#!/bin/sh
echo "Skipping systemctl $@"
exit 0
EOF
chmod +x "$1/usr/bin/systemctl"

# Import the signing key
chroot "$1" /bin/sh -c "curl -fsSL https://kaptive-signage.github.io/apt/key.gpg.asc | gpg --dearmor -o /usr/share/keyrings/kaptive.gpg"

# Add the repository
echo "deb [arch=arm64 signed-by=/usr/share/keyrings/kaptive.gpg] https://kaptive-signage.github.io/apt ${IGconf_apt_distribution} main" > "$1/etc/apt/sources.list.d/kaptive.list"

# Install kaptive
chroot "$1" /bin/sh -c "DEBIAN_FRONTEND=noninteractive apt update && DEBIAN_FRONTEND=noninteractive PLAYER_HOME_DIR=/home/kaptive apt install -y kaptive-signage"

# Restore original systemctl
if [ -e "$1/usr/bin/systemctl.orig" ]; then
    mv "$1/usr/bin/systemctl.orig" "$1/usr/bin/systemctl"
fi

# Remove policy-rc.d
rm -f "$1/usr/sbin/policy-rc.d"

# Copy labwc compositor service
cat ../labwc.service.tpl > $1/etc/systemd/system/labwc.service

# Copy squeekboard virtual keyboard service
cat ../squeekboard.service.tpl > $1/etc/systemd/system/squeekboard.service

# Setup kaptive application directory
mkdir -p $1/opt/kaptive
# Permissions will be set by firstboot after user is known
chmod -R 755 $1/opt/kaptive

# Store labwc config in /etc/skel so it gets copied to any new user's home
# This makes the config username-agnostic
mkdir -p $1/etc/skel/.config/labwc
cat ../labwc-rc.xml.tpl > $1/etc/skel/.config/labwc/rc.xml
cat ../labwc-autostart.tpl > $1/etc/skel/.config/labwc/autostart
chmod -R 755 $1/etc/skel/.config

# Customize NetworkManager-wait-online.service timeout
if [ -f "$1/lib/systemd/system/NetworkManager-wait-online.service" ]; then
    sed -i 's/Environment=NM_ONLINE_TIMEOUT=60/Environment=NM_ONLINE_TIMEOUT=15/' "$1/lib/systemd/system/NetworkManager-wait-online.service"
fi

# Customize systemd-networkd-wait-online.service timeout
if [ -f "$1/lib/systemd/system/systemd-networkd-wait-online.service" ]; then
    sed -i 's|ExecStart=/lib/systemd/systemd-networkd-wait-online|ExecStart=/lib/systemd/systemd-networkd-wait-online --timeout=15|' "$1/lib/systemd/system/systemd-networkd-wait-online.service"
fi

# Copy nginx fileserver configuration and replace PLAYER_URL placeholder
mkdir -p "$1/etc/nginx/sites-available"
mkdir -p "$1/etc/nginx/sites-enabled"
sed "s|<PLAYER_URL>|${IGconf_device_player_url}|g" ../fileserver/nginx.conf.tpl > "$1/etc/nginx/sites-available/fileserver"
ln -sf /etc/nginx/sites-available/fileserver "$1/etc/nginx/sites-enabled/fileserver"

# Enable services so they start automatically
$BDEBSTRAP_HOOKS/enable-units "$1" labwc
$BDEBSTRAP_HOOKS/enable-units "$1" squeekboard
$BDEBSTRAP_HOOKS/enable-units "$1" kaptive-player-agent
$BDEBSTRAP_HOOKS/enable-units "$1" kaptive-launcher
$BDEBSTRAP_HOOKS/enable-units "$1" nginx

# Enable network manager wait online service
$BDEBSTRAP_HOOKS/enable-units "$1" NetworkManager-wait-online.service
